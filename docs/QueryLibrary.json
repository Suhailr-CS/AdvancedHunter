[
    {
        "name": "Email NetworkMessageId -> UrlClickEvents for Similar Emails",
        "description": "Finds URL click events from emails similar to the specified NetworkMessageId, based on sender, subject, and other attributes.",
        "requiredKvps": ["networkmessageid"],
        "template": "// Find URL clicks from similar emails to NetworkMessageId: {{networkmessageid}}\nlet NETWORKMESSAGEID = \"{{networkmessageid}}\";\nlet ARRAY_FROM_TABLE_COLUMN = (TABLE: (*), COLUMN:string) {\n        set_difference(toscalar(TABLE | summarize make_set(column_ifexists(COLUMN, \"\"))), dynamic([\"\"]))\n};\nlet GET_SIMILAR_EMAILS = (NETWORKMESSAGEID: string) {\n    let Attributes = materialize (\n        EmailEvents\n        | where NetworkMessageId =~ NETWORKMESSAGEID\n        | distinct \n            SenderMailFromAddress,\n            SenderMailFromDomain,\n            SenderDisplayName,\n            SenderFromAddress,\n            SenderFromDomain,\n            EmailClusterId,\n            Subject = tolower(Subject),\n            EmailSize\n        );\n    let INITIALSENDERMAILFROMADDRESSES = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderMailFromAddress\");\n    let INITIALSENDERMAILFROMDOMAINS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderMailFromDomain\");\n    let INITIALSENDERDISPLAYNAMES = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderDisplayName\");\n    let INITIALSENDERFROMADDRESSES = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderFromAddress\");\n    let INITIALSENDERFROMDOMAINS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderFromDomain\");\n    let INITIALEMAILCLUSTERIDS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"EmailClusterId\");\n    let INITIALSUBJECTS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"Subject\");\n    let AVGEMAILSIZE = tolong(toscalar(Attributes | summarize avg(EmailSize)));\n    let MINEMAILSIZE = 0.8*AVGEMAILSIZE;\n    let MAXEMAILSIZE = 1.2*AVGEMAILSIZE;\n    EmailEvents\n    | where \n        SenderMailFromAddress in~ (INITIALSENDERMAILFROMADDRESSES) or\n        SenderMailFromDomain in~ (INITIALSENDERMAILFROMDOMAINS) or\n        SenderDisplayName in~ (INITIALSENDERDISPLAYNAMES) or\n        SenderFromAddress in~ (INITIALSENDERFROMADDRESSES) or\n        SenderFromDomain in~ (INITIALSENDERFROMDOMAINS) or\n        EmailClusterId in (INITIALEMAILCLUSTERIDS)\n    | where EmailSize between (MINEMAILSIZE .. MAXEMAILSIZE) and DeliveryLocation !~ \"On-premises/external\"\n    | extend InitialSubjects = INITIALSUBJECTS\n    | mv-expand InitialSubject = InitialSubjects\n    | extend InitialSubject = tostring(InitialSubject)\n    | where (jaccard_index(extract_all(\"([a-z]+)\", tolower(Subject)), extract_all(\"([a-z]+)\",InitialSubject)) > 0.5 or EmailClusterId in (INITIALEMAILCLUSTERIDS))\n    | project-away Initial*\n    | summarize arg_max(Timestamp, *) by NetworkMessageId, RecipientEmailAddress\n};\nGET_SIMILAR_EMAILS(NETWORKMESSAGEID)\n| join kind=rightsemi UrlClickEvents on NetworkMessageId"
    },
    {
        "name": "Email NetworkMessageId -> Similar Emails",
        "description": "Finds emails similar to the specified NetworkMessageId, based on sender, subject, and other attributes.",
        "requiredKvps": ["networkmessageid"],
        "template": "// Find similar emails to NetworkMessageId: {{networkmessageid}}\nlet NETWORKMESSAGEID = \"{{networkmessageid}}\";\nlet ARRAY_FROM_TABLE_COLUMN = (TABLE: (*), COLUMN:string) {\n        set_difference(toscalar(TABLE | summarize make_set(column_ifexists(COLUMN, \"\"))), dynamic([\"\"]))\n};\nlet GET_SIMILAR_EMAILS = (NETWORKMESSAGEID: string) {\n    let Attributes = materialize (\n        EmailEvents\n        | where NetworkMessageId =~ NETWORKMESSAGEID\n        | distinct \n            SenderMailFromAddress,\n            SenderMailFromDomain,\n            SenderDisplayName,\n            SenderFromAddress,\n            SenderFromDomain,\n            EmailClusterId,\n            Subject = tolower(Subject),\n            EmailSize\n        );\n    let INITIALSENDERMAILFROMADDRESSES = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderMailFromAddress\");\n    let INITIALSENDERMAILFROMDOMAINS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderMailFromDomain\");\n    let INITIALSENDERDISPLAYNAMES = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderDisplayName\");\n    let INITIALSENDERFROMADDRESSES = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderFromAddress\");\n    let INITIALSENDERFROMDOMAINS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"SenderFromDomain\");\n    let INITIALEMAILCLUSTERIDS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"EmailClusterId\");\n    let INITIALSUBJECTS = ARRAY_FROM_TABLE_COLUMN(Attributes, \"Subject\");\n    let AVGEMAILSIZE = tolong(toscalar(Attributes | summarize avg(EmailSize)));\n    let MINEMAILSIZE = 0.8*AVGEMAILSIZE;\n    let MAXEMAILSIZE = 1.2*AVGEMAILSIZE;\n    EmailEvents\n    | where \n        SenderMailFromAddress in~ (INITIALSENDERMAILFROMADDRESSES) or\n        SenderMailFromDomain in~ (INITIALSENDERMAILFROMDOMAINS) or\n        SenderDisplayName in~ (INITIALSENDERDISPLAYNAMES) or\n        SenderFromAddress in~ (INITIALSENDERFROMADDRESSES) or\n        SenderFromDomain in~ (INITIALSENDERFROMDOMAINS) or\n        EmailClusterId in (INITIALEMAILCLUSTERIDS)\n    | where EmailSize between (MINEMAILSIZE .. MAXEMAILSIZE) and DeliveryLocation !~ \"On-premises/external\"\n    | extend InitialSubjects = INITIALSUBJECTS\n    | mv-expand InitialSubject = INITIALSUBJECTS\n    | extend InitialSubject = tostring(InitialSubject)\n    | where (jaccard_index(extract_all(\"([a-z]+)\", tolower(Subject)), extract_all(\"([a-z]+)\",InitialSubject)) > 0.5 or EmailClusterId in (INITIALEMAILCLUSTERIDS))\n    | project-away Initial*\n    | summarize arg_max(Timestamp, *) by NetworkMessageId, RecipientEmailAddress\n};\nGET_SIMILAR_EMAILS(NETWORKMESSAGEID)"
    },
    {
        "name": "DeviceProcessEvents ProcessName -> DeviceProcessEvents",
        "description": "Finds DeviceProcessEvents for a specified process name, optionally within a lookback period.",
        "requiredKvps": ["processname"],
        "optionalKvps": ["lookback"],
        "template": "// Find DeviceProcessEvents for process name: {{processname}}\nlet PROCESSNAME = \"{{processname}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nDeviceProcessEvents\n| where ProcessName == PROCESSNAME\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by DeviceId, ProcessName"
    },
    {
        "name": "DeviceLogonEvents Username -> DeviceLogonEvents",
        "description": "Finds DeviceLogonEvents for a specified username, optionally within a lookback period.",
        "requiredKvps": ["username"],
        "optionalKvps": ["lookback"],
        "template": "// Find DeviceLogonEvents for username: {{username}}\nlet USERNAME = \"{{username}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nDeviceLogonEvents\n| where AccountName == USERNAME\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by DeviceId, AccountName"
    },
    {
        "name": "AlertEvidence AlertID -> AlertEvidence",
        "description": "Finds AlertEvidence for a specified alert ID, optionally within a lookback period.",
        "requiredKvps": ["alertid"],
        "optionalKvps": ["lookback"],
        "template": "// Find AlertEvidence for alert ID: {{alertid}}\nlet ALERTID = \"{{alertid}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nAlertEvidence\n| where AlertId == ALERTID\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by AlertId"
    },
    {
        "name": "EmailEvents SenderDomain -> EmailEvents",
        "description": "Finds EmailEvents for a specified sender domain, optionally within a lookback period.",
        "requiredKvps": ["senderdomain"],
        "optionalKvps": ["lookback"],
        "template": "// Find EmailEvents for sender domain: {{senderdomain}}\nlet SENDERDOMAIN = \"{{senderdomain}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nEmailEvents\n| where SenderMailFromDomain == SENDERDOMAIN\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by NetworkMessageId, SenderMailFromDomain"
    },
    {
        "name": "UrlClickEvents RecipientEmailAddress -> UrlClickEvents",
        "description": "Finds UrlClickEvents for a specified recipient email address, optionally within a lookback period.",
        "requiredKvps": ["recipientemailaddress"],
        "optionalKvps": ["lookback"],
        "template": "// Find UrlClickEvents for recipient email address: {{recipientemailaddress}}\nlet RECIPIENTEMAILADDRESS = \"{{recipientemailaddress}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nUrlClickEvents\n| where RecipientEmailAddress == RECIPIENTEMAILADDRESS\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by NetworkMessageId, RecipientEmailAddress, Url"
    },
    {
        "name": "DeviceFileEvents Filename -> DeviceFileEvents",
        "description": "Finds DeviceFileEvents for a specified filename, optionally within a lookback period.",
        "requiredKvps": ["filename"],
        "optionalKvps": ["lookback"],
        "template": "// Find DeviceFileEvents for filename: {{filename}}\nlet FILENAME = \"{{filename}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nDeviceFileEvents\n| where FileName == FILENAME\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by DeviceId, FileName"
    },
    {
        "name": "IdentityLogonEvents AccountUPN Device -> IdentityLogonEvents",
        "description": "Finds IdentityLogonEvents for a specified account UPN and device.",
        "requiredKvps": ["accountupn", "device"],
        "template": "// Find IdentityLogonEvents for AccountUPN and Device\nlet ACCOUNTUPN = \"{{accountupn}}\";\nlet DEVICE = \"{{device}}\";\nIdentityLogonEvents\n| where AccountUpn == ACCOUNTUPN and DeviceName == DEVICE\n| summarize arg_max(Timestamp, *) by AccountUpn, DeviceName"
    },
    {
        "name": "EntraIdSignInEvents IPAddress -> EntraIdSignInEvents",
        "description": "Finds EntraIdSignInEvents for a specified IP address, optionally within a lookback period.",
        "requiredKvps": ["ipaddress"],
        "optionalKvps": ["lookback"],
        "template": "// Find EntraIdSignInEvents for IP address: {{ipaddress}}\nlet IPADDRESS = \"{{ipaddress}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nEntraIdSignInEvents\n| where IPAddress == IPADDRESS\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by AccountObjectId, IPAddress"
    },
    {
        "name": "DeviceNetworkEvents IPAddress -> DeviceNetworkEvents",
        "description": "Finds DeviceNetworkEvents for a specified IP address, optionally within a lookback period.",
        "requiredKvps": ["ipaddress"],
        "optionalKvps": ["lookback"],
        "template": "// Find DeviceNetworkEvents for IP address: {{ipaddress}}\nlet IPADDRESS = \"{{ipaddress}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 24h);\nDeviceNetworkEvents\n| where RemoteIP == IPADDRESS or LocalIP == IPADDRESS\n| where Timestamp > ago(LOOKBACK)\n| summarize arg_max(Timestamp, *) by DeviceId, RemoteIP, LocalIP"
    },
    {
        "name": "Email NetworkMessageId -> DeviceFileEvents for Email Attachments",
        "description": "Finds DeviceFileEvents for attachments from the email with the specified NetworkMessageId.",
        "requiredKvps": ["networkmessageid"],
        "template": "// Find DeviceFileEvents for email attachments from email with NetworkMessageId: {{networkmessageid}}\nlet NETWORKMESSAGEID = \"{{networkmessageid}}\";\nlet Lookup = (TABLE: (*), KEY:string, VALUE:string) {\n    TABLE\n    | where column_ifexists(KEY, \"\") =~ VALUE\n};\nlet dynamicLookup = (SOURCE_TABLE: (*), TARGET_TABLE: (*), SOURCE_COLUMN:string, TARGET_COLUMN:string = \"\") {\n    let LOOKUPVALUES = set_difference(toscalar(SOURCE_TABLE | summarize make_set(column_ifexists(SOURCE_COLUMN, \"\"))), dynamic([\"\"]));\n    TARGET_TABLE\n    | where column_ifexists(TARGET_COLUMN, \"\") in~ (LOOKUPVALUES) and isnotempty(column_ifexists(TARGET_COLUMN, \"\"))\n};\ndynamicLookup(\nLookup(EmailAttachmentInfo, \"NetworkMessageId\", NETWORKMESSAGEID),\nDeviceFileEvents,\n\"SHA256\",\n\"SHA256\"\n)"
    },
    {
        "name": "Entra ID Protection Alert ID -> UrlClickEvents for Compromised User",
        "description": "Finds URL click events for a potentially compromised user based on an Entra ID Protection alert ID.",
        "requiredKvps": ["alertid"],
        "template": "// UrlClickEvents occurring before Entra ID Protection Alert {{alertid}}\nlet ALERTID = \"{{alertid}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 45m);\nlet ARRAY_FROM_TABLE_COLUMN = (TABLE: (*), COLUMN:string) {\n        set_difference(toscalar(TABLE | summarize make_set(column_ifexists(COLUMN, \"\"))), dynamic([\"\"]))\n};\nlet GET_ALERT_EVIDENCE = (ALERT_ID:string) {\n    AlertEvidence\n    | where AlertId endswith ALERT_ID\n    | extend AdditionalFields = todynamic(AdditionalFields)\n    | extend MergeByKeyHex = tostring(AdditionalFields.MergeByKeyHex)\n    | summarize arg_max(column_ifexists(\"TimeGenerated\",Timestamp), *) by MergeByKeyHex\n    | evaluate bag_unpack(AdditionalFields, columnsConflict='keep_source')\n};\nlet GET_ACCOUNT_IDENTIFIER = (ACCOUNT_OBJECT_ID:string, OUTPUT_COLUMN:string){toscalar(\n    IdentityInfo\n    | where AccountObjectId == ACCOUNT_OBJECT_ID and isnotempty(column_ifexists(OUTPUT_COLUMN,\"\")) and Timestamp > ago(14d)\n    | summarize arg_max(Timestamp,*) by AccountObjectId\n    | project column_ifexists(OUTPUT_COLUMN,\"\"))\n};\nlet ALERTEVIDENCE =     materialize(GET_ALERT_EVIDENCE(ALERTID));\nlet SESSIONID =         tostring(ARRAY_FROM_TABLE_COLUMN((ALERTEVIDENCE),\"SessionId\")[0]);\nlet REQUESTID =         tostring(ARRAY_FROM_TABLE_COLUMN((ALERTEVIDENCE),\"RequestId\")[0]);\nlet ACCOUNTOBJECTID =   tostring(ARRAY_FROM_TABLE_COLUMN(ALERTEVIDENCE,\"AccountObjectId\")[0]);\nlet ACCOUNTUPN =        GET_ACCOUNT_IDENTIFIER(ACCOUNTOBJECTID, \"AccountUpn\");\nlet EMAILADDRESS =      GET_ACCOUNT_IDENTIFIER(ACCOUNTOBJECTID, \"EmailAddress\");\nlet SUSPICIOUSSIGNINS = materialize(\n    EntraIdSignInEvents\n    | where AccountObjectId =~ ACCOUNTOBJECTID\n    | where\n        SessionId =~ SESSIONID or\n        RequestId =~ REQUESTID\n    | join kind=rightsemi EntraIdSignInEvents on CorrelationId\n);\nlet MINSUSPICIOUSSIGNINTIMESTAMP = todatetime(toscalar(SUSPICIOUSSIGNINS | summarize min(Timestamp)));\nUrlClickEvents\n| where AccountUpn in~ (EMAILADDRESS, ACCOUNTUPN) and Timestamp between ((MINSUSPICIOUSSIGNINTIMESTAMP - 30m) .. MINSUSPICIOUSSIGNINTIMESTAMP)\n| summarize arg_max(Timestamp,*) by NetworkMessageId, Url"
    },
    {
        "name": "Entra ID Protection Alert ID -> UrlClickEvents for Compromised User (First Contact Email)",
        "description": "Finds URL click events for a potentially compromised user based on an Entra ID Protection alert ID. Specifically, URL clicks from emails that are the first contact between a sender to the recipient.",
        "requiredKvps": ["alertid"],
        "optionalKvps": ["lookback"],
        "template": "// UrlClickEvents occurring before Entra ID Protection Alert {{alertid}}\n// This shows UrlClickEvents for emails coming from a sender the recipient has not recieved a message from before\nlet ALERTID = \"{{alertid}}\";\nlet LOOKBACK = iff(isnotempty(totimespan(\"{{lookback}}\")), totimespan(\"{{lookback}}\"), 45m);\nlet ARRAY_FROM_TABLE_COLUMN = (TABLE: (*), COLUMN:string) {\n        set_difference(toscalar(TABLE | summarize make_set(column_ifexists(COLUMN, \"\"))), dynamic([\"\"]))\n};\nlet GET_ALERT_EVIDENCE = (ALERT_ID:string) {\n    AlertEvidence\n    | where AlertId endswith ALERT_ID\n    | extend AdditionalFields = todynamic(AdditionalFields)\n    | extend MergeByKeyHex = tostring(AdditionalFields.MergeByKeyHex)\n    | summarize arg_max(column_ifexists(\"TimeGenerated\",Timestamp), *) by MergeByKeyHex\n    | evaluate bag_unpack(AdditionalFields, columnsConflict='keep_source')\n};\nlet GET_ACCOUNT_IDENTIFIER = (ACCOUNT_OBJECT_ID:string, OUTPUT_COLUMN:string){toscalar(\n    IdentityInfo\n    | where AccountObjectId == ACCOUNT_OBJECT_ID and isnotempty(column_ifexists(OUTPUT_COLUMN,\"\")) and Timestamp > ago(14d)\n    | summarize arg_max(Timestamp,*) by AccountObjectId\n    | project column_ifexists(OUTPUT_COLUMN,\"\"))\n};\nlet ALERTEVIDENCE =     materialize(GET_ALERT_EVIDENCE(ALERTID));\nlet SESSIONID =         tostring(ARRAY_FROM_TABLE_COLUMN((ALERTEVIDENCE),\"SessionId\")[0]);\nlet REQUESTID =         tostring(ARRAY_FROM_TABLE_COLUMN((ALERTEVIDENCE),\"RequestId\")[0]);\nlet ACCOUNTOBJECTID =   tostring(ARRAY_FROM_TABLE_COLUMN(ALERTEVIDENCE,\"AccountObjectId\")[0]);\nlet ACCOUNTUPN =        GET_ACCOUNT_IDENTIFIER(ACCOUNTOBJECTID, \"AccountUpn\");\nlet EMAILADDRESS =      GET_ACCOUNT_IDENTIFIER(ACCOUNTOBJECTID, \"EmailAddress\");\nlet SUSPICIOUSSIGNINS = materialize(\n    EntraIdSignInEvents\n    | where AccountObjectId =~ ACCOUNTOBJECTID\n    | where\n        SessionId =~ SESSIONID or\n        RequestId =~ REQUESTID\n    | join kind=rightsemi EntraIdSignInEvents on CorrelationId\n);\nlet MINSUSPICIOUSSIGNINTIMESTAMP = todatetime(toscalar(SUSPICIOUSSIGNINS | summarize min(Timestamp)));\nUrlClickEvents\n| where AccountUpn in~ (EMAILADDRESS, ACCOUNTUPN) and Timestamp between ((MINSUSPICIOUSSIGNINTIMESTAMP - 30m) .. MINSUSPICIOUSSIGNINTIMESTAMP)\n| summarize arg_max(Timestamp,*) by NetworkMessageId, Url\n| join kind=leftsemi (EmailEvents | where IsFirstContact) on NetworkMessageId"
    }
]
